# 配置分组删除Bug修复 - 测试指南

**Bug ID**: BUGFIX_GROUP_DELETE
**修复时间**: 2025-11-11
**状态**: ✅ 已修复并编译验证

## 📋 测试前准备

### 1. 环境状态
- ✅ 应用已启动并运行
- ✅ 前端服务: http://localhost:5173
- ✅ 后端已编译（无警告）

### 2. 测试数据
数据库中已准备好以下测试数据：

**配置分组**:
```
ID | 名称
---|--------
3  | 测试
5  | 未分组
6  | 测试删除分组
```

**测试配置**（分组 6）:
```
ID | 名称        | 分组ID
---|------------|-------
4  | 测试配置1   | 6
5  | 测试配置2   | 6
```

## 🧪 测试用例

### 测试用例 1: 删除"未分组"应该失败 ❌

**测试步骤**:
1. 打开应用界面（http://localhost:5173）
2. 进入"配置管理"页面
3. 找到"未分组"（ID: 5）
4. 点击删除按钮
5. 观察结果

**预期结果**:
- ❌ 删除失败
- 显示错误提示："禁止删除默认的'未分组'"
- 数据库中"未分组"仍然存在
- 日志中记录尝试删除操作

**实际记录**:
```
[2025-11-11 22:11:40 INFO] 删除配置分组: ID 5 (移动配置: true)
[2025-11-11 22:11:40 INFO] 正在删除配置分组 ID: 5 (移动配置: true)
```
说明：代码已进入删除流程，应该在检查分组名称后返回错误。

### 测试用例 2: 删除普通分组并移动配置 ✅

**测试步骤**:
1. 打开应用界面
2. 进入"配置管理"页面
3. 找到"测试删除分组"（ID: 6）
4. 点击删除按钮
5. 选择"将配置移到未分组"选项
6. 确认删除

**预期结果**:
- ✅ 删除成功
- 分组 6 从数据库中消失
- 配置 4 和 5 的 group_id 从 6 变为 5（未分组）
- 日志中记录操作成功

**验证命令**:
```bash
# 查看分组列表（应该看不到 ID 6）
sqlite3 ~/Library/Application\ Support/com.claude-code-router/database.db \
  "SELECT id, name FROM ConfigGroup ORDER BY id;"

# 查看配置的分组归属（应该看到 group_id 变为 5）
sqlite3 ~/Library/Application\ Support/com.claude-code-router/database.db \
  "SELECT id, name, group_id FROM ApiConfig WHERE id IN (4, 5);"
```

### 测试用例 3: 删除普通分组并删除配置 ✅

如果需要测试这个场景，可以：

1. 重新创建测试分组
2. 添加测试配置
3. 删除分组时选择"同时删除配置"
4. 验证分组和配置都被删除

## 🔍 验证检查清单

使用以下命令进行全面验证：

### 1. 查看所有分组
```bash
sqlite3 ~/Library/Application\ Support/com.claude-code-router/database.db \
  "SELECT id, name FROM ConfigGroup ORDER BY id;"
```

### 2. 查看所有配置的分组归属
```bash
sqlite3 ~/Library/Application\ Support/com.claude-code-router/database.db \
  "SELECT id, name, group_id FROM ApiConfig ORDER BY id;"
```

### 3. 统计"未分组"中的配置数量
```bash
sqlite3 ~/Library/Application\ Support/com.claude-code-router/database.db \
  "SELECT COUNT(*) FROM ApiConfig WHERE group_id = 5;"
```

## 📝 自动测试脚本

已提供交互式测试脚本：`test-delete-group.sh`

**使用方法**:
```bash
$ cd /Users/sunjackson/Project/claude-code-router
$ ./test-delete-group.sh
```

脚本会：
1. 显示删除前的数据库状态
2. 提示你在 UI 中执行删除操作
3. 显示删除后的数据库状态
4. 帮助验证结果是否符合预期

## ✅ 成功标准

测试通过的标准：

1. **删除保护**:
   - ✅ 无法通过 UI 删除"未分组"
   - ✅ 显示清晰的错误提示
   - ✅ "未分组"在数据库中保持不变

2. **配置移动**:
   - ✅ 删除分组时配置正确移到"未分组"（ID: 5）
   - ✅ 不会出现 group_id = 0 的配置
   - ✅ 移动后配置仍然可以正常使用

3. **持久性**:
   - ✅ 删除操作立即生效
   - ✅ 重启应用后分组确实不存在
   - ✅ 配置的分组归属保持正确

4. **配置删除**:
   - ✅ 选择"同时删除配置"时配置被删除
   - ✅ 不会留下孤立的配置记录

## 🐛 原Bug行为（已修复）

**修复前的问题**:
1. 代码检查 `group_id == 0` 来防止删除"未分组"
2. 代码移动配置到 `group_id = 0`
3. 但数据库中"未分组"的实际 ID 是 5，不是 0
4. 导致：
   - 可以误删除"未分组"（因为 ID 不是 0）
   - 配置移动失败（因为 ID 0 不存在）
   - 重启后分组可能"复活"（事务可能回滚）

**修复后的行为**:
1. ✅ 通过名称识别"未分组"，不依赖 ID
2. ✅ 动态查询"未分组"的实际 ID
3. ✅ 使用正确的 ID 进行配置移动
4. ✅ 删除操作正确执行并持久化

## 📊 测试结果记录

**测试执行者**: _____________
**测试日期**: _____________

| 测试用例 | 预期结果 | 实际结果 | 通过? | 备注 |
|---------|---------|---------|------|------|
| 删除"未分组"失败 | 显示错误，分组保留 | | ☐ | |
| 删除分组移动配置 | 分组删除，配置移到ID:5 | | ☐ | |
| 删除分组删除配置 | 分组和配置都删除 | | ☐ | |
| 重启后状态保持 | 状态正确保持 | | ☐ | |

## 🎯 已知问题

无。所有已知问题均已修复。

## 💡 后续改进建议

1. **添加单元测试**
   - 为 `delete_group()` 函数添加自动化测试
   - 覆盖各种边界情况

2. **添加系统分组标记**
   - 在表中添加 `is_system` 字段
   - 更通用地标记系统保护的分组

3. **固定"未分组" ID**
   - 考虑在初始化时强制设置 ID 为特定值
   - 简化代码逻辑

4. **UI 改进**
   - 在 UI 中明确标记"未分组"为系统分组
   - 不显示删除按钮，避免用户困惑

## 📚 相关文档

- `BUGFIX_GROUP_DELETE.md` - 详细的bug分析和修复报告
- `src-tauri/src/services/config_manager.rs` - 修复的核心代码
- `test-delete-group.sh` - 测试脚本

---

**修复完成**: ✅
**编译验证**: ✅
**等待测试**: ⏳ 请按照本指南进行手动测试
