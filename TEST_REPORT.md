# Claude Code Router 测试报告

**版本**: 1.0.0
**测试日期**: 2025-11-10
**状态**: 等待用户测试

---

## 📋 已完成的修复和配置

### 1. Tauri 版本升级 ✅

**问题**: tauri.conf.json 配置格式错误，Tauri CLI 版本不匹配
**修复**:
- 升级 Tauri 从 1.5 到 2.x
- 更新配置文件格式符合 Tauri 2.x 标准
- 添加插件系统支持

**修改的文件**:
- `src-tauri/Cargo.toml` - 依赖版本更新
- `src-tauri/tauri.conf.json` - 配置格式更新
- `src-tauri/src/main.rs` - 添加插件初始化
- `src-tauri/capabilities/default.json` - 新增权限配置

### 2. 导入路径修复 ✅

**问题**: 前端组件导入路径错误
**修复**:
- `Header.tsx:9` - `../api/proxy-service` → `../api/proxy`
- `EnvironmentVariableManager.tsx:9` - `../api/api-config` → `../api/config`

### 3. Tailwind CSS 修复 ✅

**问题**: Tailwind 样式不生效
**修复**: 在 `src-ui/src/styles/theme.css` 顶部添加：
```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

### 4. 启动脚本增强 ✅

**新增功能**:
- 自动检测 Rust/Cargo 环境
- 自动检测并安装 Tauri CLI
- 环境变量自动加载
- 交互式依赖安装

**文件**: `start-dev.sh`, `START_GUIDE.md`

---

## 🚀 启动应用

### 方法 1: 使用启动脚本（推荐）

```bash
cd /Users/sunjackson/Project/claude-code-router
./start-dev.sh
```

**首次启动说明**:
- ✅ 脚本会自动检测环境
- ✅ 如缺少 Tauri CLI，会自动询问是否安装
- ⏳ Tauri CLI 安装需要 5-10 分钟（从源码编译）
- ⏳ 首次 Rust 编译需要 5-10 分钟（543个依赖包）
- ✅ 编译完成后应用窗口会自动打开

### 方法 2: 手动启动

```bash
cd /Users/sunjackson/Project/claude-code-router/src-tauri
source ~/.cargo/env
cargo tauri dev
```

---

## 🧪 功能测试清单

### A. 基础界面测试

#### ✅ 1. 应用启动
- [ ] 应用窗口成功打开
- [ ] 窗口标题显示 "Claude Code Router"
- [ ] 窗口尺寸为 1280x800
- [ ] 黑金主题正确显示（黑色背景 + 金色强调色）

#### ✅ 2. 侧边栏导航
- [ ] 侧边栏显示 5 个导航项
  - 📊 仪表盘
  - ⚙️ 配置管理
  - 💻 Claude Code
  - ⭐ 推荐服务
  - 🔧 设置
- [ ] 点击导航项可以切换页面
- [ ] 当前页面高亮显示

### B. 仪表盘页面（Dashboard）

#### ✅ 3. 代理服务状态卡片
- [ ] 显示代理服务状态（已停止/运行中）
- [ ] 显示监听地址：127.0.0.1:25341
- [ ] 显示当前分组：未选择
- [ ] 显示当前配置：未选择
- [ ] "🔄 刷新"按钮正常工作

#### ✅ 4. 启动/停止代理服务
**前提**: 需要先创建分组和配置

- [ ] 未选择分组时，启动按钮禁用
- [ ] 显示警告："⚠️ 请先选择一个分组和配置才能启动代理服务"
- [ ] 选择分组和配置后，可以启动代理
- [ ] 启动后状态变为"运行中"
- [ ] 可以停止代理服务

#### ✅ 5. 切换分组
- [ ] 初始状态显示 "0 个分组"
- [ ] 显示提示："暂无分组，请在配置管理页面创建分组"

#### ✅ 6. 切换配置
- [ ] 未选择分组时显示："请先选择分组"
- [ ] 选择分组后显示该分组下的配置列表

### C. 配置管理页面

#### ✅ 7. 分组管理
- [ ] 可以创建新分组
  - 输入分组名称
  - 输入分组描述
  - 启用/禁用自动切换
- [ ] 显示分组列表
- [ ] 可以编辑分组信息
- [ ] 可以删除分组（会提示确认）
- [ ] 分组卡片显示：
  - 分组名称
  - 描述
  - 配置数量
  - 自动切换状态

#### ✅ 8. API 配置管理
- [ ] 可以添加新配置
  - 输入配置名称
  - 输入服务器 URL
  - 输入服务器端口
  - 输入 API 密钥
  - 选择所属分组
  - 设置优先级
- [ ] 配置列表显示：
  - 配置名称
  - 服务器地址
  - 优先级
  - 可用状态
- [ ] 可以编辑配置
- [ ] 可以删除配置
- [ ] 可以测试配置连接
- [ ] 测试结果显示：
  - 延迟（ms）
  - 连接状态
  - 错误信息（如有）

#### ✅ 9. 配置排序
- [ ] 可以拖拽调整配置优先级
- [ ] 优先级数字实时更新

### D. Claude Code 页面

#### ✅ 10. Claude Code 路径检测
- [ ] 自动检测 Claude Code 配置路径
- [ ] 显示检测到的路径（如 `~/.claude/config.json`）
- [ ] 手动输入路径功能

#### ✅ 11. 配置备份
- [ ] 显示现有备份列表
- [ ] 可以创建新备份
  - 自动生成备份名称（带时间戳）
  - 备份成功提示
- [ ] 可以恢复备份
  - 显示确认对话框
  - 恢复成功提示
- [ ] 可以删除备份

#### ✅ 12. 代理配置管理
- [ ] 可以启用代理配置
  - 修改 Claude Code config.json
  - 设置代理地址为 127.0.0.1:25341
- [ ] 可以禁用代理配置
  - 恢复原始配置
- [ ] 显示当前代理状态（已启用/未启用）

#### ✅ 13. 配置恢复
- [ ] 一键恢复 Claude Code 配置到原始状态
- [ ] 显示确认对话框
- [ ] 恢复成功提示

### E. 推荐服务页面

#### ✅ 14. 服务列表
- [ ] 显示推荐的 API 中转服务
- [ ] 服务卡片显示：
  - 服务名称
  - 服务描述
  - 官网链接
  - 特性列表
  - 推荐指数
- [ ] 可以点击"访问官网"按钮
- [ ] 可以点击"添加到配置"按钮

#### ✅ 15. 服务筛选
- [ ] 可以按关键字搜索服务
- [ ] 可以按特性筛选（如"免费"、"稳定"等）

#### ✅ 16. 刷新服务列表
- [ ] 点击"🔄 刷新"按钮
- [ ] 从远程加载最新推荐列表
- [ ] 显示加载状态
- [ ] 加载失败时显示本地缓存

### F. 设置页面

#### ✅ 17. 环境变量管理
- [ ] 显示当前环境变量列表
- [ ] 可以筛选显示：
  - 全部变量
  - 仅 Anthropic 相关变量
- [ ] 可以搜索变量名或值
- [ ] 显示/隐藏变量值（密码遮罩）

#### ✅ 18. 从配置应用到环境
- [ ] 点击"从配置应用"按钮
- [ ] 弹出配置选择对话框
- [ ] 选择 API 配置
- [ ] 将配置的 API 密钥设置到环境变量
- [ ] 显示成功提示

#### ✅ 19. 清除环境变量
- [ ] 点击"清除 Anthropic 变量"按钮
- [ ] 显示确认对话框
- [ ] 清除所有 ANTHROPIC_* 相关变量
- [ ] 列表实时更新

#### ✅ 20. 国际化切换
- [ ] 点击语言切换按钮（🇨🇳 中文 / 🇺🇸 English）
- [ ] 界面语言切换
- [ ] 设置持久化保存

### G. 高级功能测试

#### ✅ 21. 代理服务自动切换
**前提**: 分组已启用自动切换

- [ ] 当前配置不可用时自动切换
- [ ] 切换到同组下一个优先级配置
- [ ] 显示切换日志

#### ✅ 22. 连接测试
- [ ] 测试单个 API 配置连接
- [ ] 测试整个分组的所有配置
- [ ] 并发测试性能
- [ ] 测试结果排序（按延迟）

#### ✅ 23. 切换日志
- [ ] 查看历史切换记录
- [ ] 显示：
  - 切换时间
  - 从哪个配置切换
  - 切换到哪个配置
  - 切换原因

### H. 数据持久化测试

#### ✅ 24. 数据保存
- [ ] 创建的分组和配置保存到数据库
- [ ] 关闭应用后重新打开，数据仍然存在
- [ ] API 密钥存储在系统密钥链（加密）

#### ✅ 25. 配置导入导出（未实现）
此功能在当前版本中未实现，可以作为未来增强。

---

## 🐛 已知问题

### 1. 首次启动时的错误信息（正常现象）

**现象**:
浏览器打开 http://localhost:5173 时显示：
```
window.__TAURI_IPC__ is not a function
```

**原因**:
- 前端 Vite 服务器已启动
- Rust 后端还在编译中（首次需要 5-10 分钟）
- Tauri IPC 接口尚未注入

**解决**:
等待编译完成，Tauri 桌面窗口打开后，此错误会自动消失。

### 2. Tauri 版本警告（可忽略）

**现象**:
```
Error Failed to parse version `^2.0.0` for crate `tauri`
```

**原因**:
tauri-cli 的版本解析警告，不影响功能。

**影响**:
无，可正常编译和运行。

---

## 📊 预期测试结果

### 正常情况下应看到：

1. **应用窗口**
   - 黑色背景
   - 金色强调色（按钮、标题、图标）
   - 左侧导航栏
   - 右侧内容区域

2. **数据库文件**
   ```bash
   ~/.local/share/com.claude-code-router.app/claude_code_proxy.db
   ```

3. **日志文件**
   ```bash
   ~/.local/share/com.claude-code-router.app/logs/
   ```

4. **Claude Code 配置备份**
   ```bash
   ~/.claude-code-proxy/backups/
   ```

---

## 🔧 故障排查

### 问题 1: 编译失败

**检查**:
```bash
rustc --version  # 应显示 1.70+
cargo --version  # 应显示 1.70+
cargo tauri --version  # 应显示 2.x
```

**解决**:
```bash
# 重新安装 Tauri CLI
cargo install tauri-cli --locked

# 清理构建缓存
cd src-tauri
cargo clean
```

### 问题 2: 前端无法访问

**检查**:
```bash
# 端口是否被占用
lsof -ti:5173

# 如果被占用，清理
kill -9 $(lsof -ti:5173)
```

### 问题 3: 窗口不显示

**检查**:
```bash
# 查看 Tauri 日志
tail -f ~/.local/share/com.claude-code-router.app/logs/tauri.log
```

### 问题 4: API 调用失败

**检查**:
1. 打开开发者工具（应用内按 F12 或 Cmd+Option+I）
2. 查看 Console 标签页错误信息
3. 查看 Network 标签页请求详情

---

## 📝 测试注意事项

### 1. 测试顺序建议

建议按以下顺序测试，因为某些功能依赖其他功能：

1. 先测试**配置管理** → 创建分组和配置
2. 再测试**仪表盘** → 启动代理服务
3. 然后测试**Claude Code** → 配置代理
4. 最后测试**其他功能**

### 2. 测试数据建议

**创建测试分组**:
- 分组名称：测试分组 1
- 描述：用于测试的分组
- 自动切换：启用

**创建测试配置**:
- 配置 1:
  - 名称：测试配置 A
  - URL：https://api.anthropic.com
  - 端口：443
  - API Key：sk-ant-test-key-1
  - 优先级：1

- 配置 2:
  - 名称：测试配置 B
  - URL：https://api.anthropic.com
  - 端口：443
  - API Key：sk-ant-test-key-2
  - 优先级：2

### 3. 破坏性测试

以下操作会修改系统配置，测试前请备份：

- ❌ 启用 Claude Code 代理（会修改 ~/.claude/config.json）
- ❌ 应用配置到环境（会设置环境变量）
- ❌ 清除 Anthropic 变量（会删除环境变量）

**建议**:
1. 先备份 Claude Code 配置
2. 测试完成后恢复配置
3. 或在虚拟机/测试环境中测试

---

## ✅ 测试完成标准

当完成所有测试项（至少 20/25）且核心功能正常时，可以认为测试通过。

核心功能包括：
- ✅ 应用启动和 UI 显示
- ✅ 分组和配置管理
- ✅ 代理服务启动/停止
- ✅ API 连接测试
- ✅ Claude Code 配置管理

---

## 📞 报告问题

如果发现问题，请记录以下信息：

1. **错误现象**: 详细描述看到的错误
2. **复现步骤**: 如何触发这个错误
3. **错误日志**:
   - 浏览器控制台（F12）
   - Tauri 日志（~/.local/share/.../logs/）
4. **系统信息**:
   - macOS 版本
   - Node.js 版本
   - Rust 版本

---

**祝测试顺利！** 🎉
