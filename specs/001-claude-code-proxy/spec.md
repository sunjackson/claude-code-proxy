# Feature Specification: Claude Code 代理服务管理应用

**Feature Branch**: `001-claude-code-proxy`
**Created**: 2025-11-08
**Status**: Draft
**Input**: User description: "开发一个应用,实现本地claude code代理服务,支持备份claude code配置以及一键配置设置将claude code的路由以及模型配置指向本地127.0.0.1的端口服务上,客户端实现下面功能:一键切换多个中转站API配置; 一键切换系统环境变量,一键测试API延迟,一键测试API有效性,自动择优线路切换与国际化支持,出现费用不足则自动负载到下一个配置"

## Clarifications

### Session 2025-11-08 - Round 1 (推荐服务与基础配置)

- Q: 推荐服务 JSON 文件的数据结构应该如何设计? → A: 只用做跳转,展示站点名称、推广链接、是否推荐、热度
- Q: 远程和本地 JSON 文件的加载优先级策略是什么? → A: 优先远程,失败时回退本地
- Q: 远程 JSON 文件的安全验证策略应该如何设计? → A: 不验证,直接使用
- Q: 本地代理服务的默认监听端口应该设置为多少? → A: 25341
- Q: 自动择优切换功能的延迟阈值默认值应该设置为多少? → A: 3s

### Session 2025-11-08 - Round 2 (配置分组功能)

- Q: 当用户首次使用应用时,分组的初始化策略应该是什么? → A: 允许无分组状态下添加配置(配置可以属于"未分组"状态)
- Q: 用户切换分组时,代理服务的状态应该如何处理? → A: 自动切换到新分组的第一个可用配置(无需重启代理服务)
- Q: 当分组内启用自动切换时,配置的选择顺序应该如何确定? → A: 按用户添加的顺序依次切换(用户可以通过拖拽调整优先级)
- Q: 当用户切换到一个空分组(没有任何配置)时,系统应该如何处理? → A: 阻止切换并提示用户"该分组没有任何配置,请先添加配置"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 配置 Claude Code 本地代理 (Priority: P1)

用户需要将 Claude Code 的 API 请求路由到本地代理服务器,以便使用自定义的 API 中转服务。用户打开应用后,可以一键将 Claude Code 的配置文件修改为指向本地 127.0.0.1 的代理端口,并在需要时恢复原始配置。

**Why this priority**: 这是整个应用的核心功能,没有这个功能,其他所有功能都无法运行。这是最小可行产品(MVP)的基础。

**Independent Test**: 用户可以通过点击"启用本地代理"按钮,然后打开 Claude Code 验证其请求是否通过本地端口发送。通过点击"恢复原始配置"按钮,验证 Claude Code 恢复正常连接。

**Acceptance Scenarios**:

1. **Given** 用户已安装 Claude Code, **When** 用户点击"启用本地代理"按钮, **Then** Claude Code 的配置文件被修改为指向 127.0.0.1:指定端口,并显示成功提示
2. **Given** 本地代理已启用, **When** 用户在 Claude Code 中发送请求, **Then** 请求通过本地代理服务器转发
3. **Given** 本地代理已启用, **When** 用户点击"恢复原始配置"按钮, **Then** Claude Code 的配置恢复到原始状态,并显示成功提示
4. **Given** 用户首次启用本地代理, **When** 配置被修改前, **Then** 系统自动备份原始配置文件

---

### User Story 2 - 管理多个 API 中转站配置和分组 (Priority: P1)

用户希望在应用中添加、编辑和管理多个 API 中转站配置(包括 API 密钥、服务器地址、端口等),并能够将配置组织到不同的分组中。同一分组内的配置可以共享自动负载均衡和故障切换策略,用户可以快速在不同分组或配置间切换。

**Why this priority**: 这是核心价值功能,用户需要管理多个 API 配置并通过分组来实现灵活的负载均衡策略。分组功能允许用户为不同场景(如工作、个人、测试等)设置独立的配置集合和切换策略。

**Independent Test**: 用户可以创建至少 2 个分组(如"工作"和"个人"),在每个分组中添加至少 2 个不同的 API 配置,然后切换到某个分组,验证代理服务只在该分组内的配置间进行自动切换。

**Acceptance Scenarios**:

1. **Given** 用户打开配置管理界面, **When** 用户创建新分组并填写分组名称, **Then** 分组被创建并显示在分组列表中
2. **Given** 用户首次使用应用未创建任何分组, **When** 用户直接添加 API 配置, **Then** 配置被添加到"未分组"状态并可以正常使用
3. **Given** 用户已创建分组, **When** 用户在某个分组下添加 API 配置(名称、API 密钥、服务器地址、端口), **Then** 配置被添加到该分组中并持久化保存
4. **Given** 用户已有多个分组, **When** 用户选择某个分组作为当前使用的分组, **Then** 系统自动切换到该分组的第一个可用配置,无需重启代理服务
5. **Given** 用户试图切换到空分组, **When** 用户选择该分组, **Then** 系统阻止切换并提示"该分组没有任何配置,请先添加配置"
6. **Given** 用户已有保存的配置, **When** 用户点击编辑按钮修改配置信息或更改配置所属分组, **Then** 配置被更新并保存
7. **Given** 用户已有保存的配置, **When** 用户点击删除按钮, **Then** 系统提示确认,确认后配置被删除
8. **Given** 用户已有多个分组, **When** 用户删除某个分组, **Then** 系统提示确认并询问是否同时删除该分组下的所有配置
9. **Given** 用户在某个分组内有多个配置, **When** 用户通过拖拽调整配置的顺序, **Then** 配置的排序顺序被更新,影响自动切换时的优先级

---

### User Story 3 - 测试 API 连接性和延迟 (Priority: P2)

用户需要快速测试各个 API 配置的连接状态、响应延迟和有效性,以便选择最佳的服务。

**Why this priority**: 这个功能帮助用户做出明智的选择,但用户也可以手动切换配置来测试。它提升了用户体验,但不是核心功能的必需部分。

**Independent Test**: 用户可以在配置列表中点击某个配置的"测试"按钮,在几秒钟内看到该配置的连接状态(成功/失败)、响应延迟(毫秒)和 API 有效性结果。

**Acceptance Scenarios**:

1. **Given** 用户已有保存的 API 配置, **When** 用户点击"测试连接"按钮, **Then** 系统显示测试进行中的状态,然后显示响应延迟(如 250ms)和连接状态(成功/失败)
2. **Given** 用户已有多个 API 配置, **When** 用户点击"测试全部"按钮, **Then** 系统依次测试所有配置,并在列表中显示每个配置的延迟和状态
3. **Given** 某个 API 配置不可用, **When** 系统测试该配置, **Then** 显示"连接失败"状态和错误原因(如"超时"、"认证失败")

---

### User Story 4 - 分组内自动择优路由切换 (Priority: P2)

用户希望系统能够在当前分组内自动监测 API 配置的可用性和性能,当当前配置出现问题(如延迟过高、连接失败、费用不足)时,自动切换到同一分组内下一个可用的最优配置。自动切换仅在同一分组内进行,不会跨分组切换。

**Why this priority**: 这是自动化功能,能显著提升用户体验,但用户也可以手动切换。分组隔离的自动切换确保了不同使用场景的配置不会相互干扰。

**Independent Test**: 用户在某个分组中启用"自动择优切换"功能后,模拟当前 API 配置失败(如停止该服务),观察系统是否仅在该分组内按照配置顺序自动切换到下一个可用配置,而不会切换到其他分组的配置,并显示切换通知。

**Acceptance Scenarios**:

1. **Given** 用户在某个分组中启用了"自动择优切换"功能, **When** 当前使用的 API 配置出现连接失败或超时, **Then** 系统按照配置列表顺序自动切换到同一分组内下一个可用的配置,并显示通知
2. **Given** 用户在某个分组中启用了"自动择优切换"功能, **When** 当前 API 返回"费用不足"或"配额已用完"的错误, **Then** 系统按照配置顺序自动切换到同一分组内下一个可用配置,并记录切换日志
3. **Given** 用户在某个分组中启用了"自动择优切换"功能并设置了延迟阈值, **When** 当前配置的延迟超过阈值, **Then** 系统按照配置顺序自动切换到同一分组内下一个可用且延迟更低的配置
4. **Given** 用户调整了分组内配置的顺序, **When** 系统执行自动切换, **Then** 系统按照用户调整后的顺序依次尝试切换到下一个可用配置
5. **Given** 当前分组内所有 API 配置都不可用, **When** 系统尝试自动切换, **Then** 显示错误提示"当前分组内所有 API 配置均不可用",并保持当前配置,不切换到其他分组
6. **Given** 用户启用了自动切换功能, **When** 系统在分组内进行自动切换, **Then** 切换仅限于当前分组,不会切换到其他分组的配置

---

### User Story 5 - 管理系统环境变量 (Priority: P3)

用户需要通过应用快速设置和切换与 Claude Code 相关的系统环境变量(如代理地址、API 密钥等),以便在不同环境或配置间切换。

**Why this priority**: 这是辅助功能,主要面向高级用户。大多数用户只需要应用内的配置切换,不需要修改系统环境变量。

**Independent Test**: 用户可以在应用中查看当前系统环境变量,点击"应用环境变量"按钮设置特定变量,然后通过命令行验证环境变量已正确设置。

**Acceptance Scenarios**:

1. **Given** 用户打开环境变量管理界面, **When** 用户查看当前环境变量, **Then** 显示与 Claude Code 相关的所有环境变量及其值
2. **Given** 用户选择了某个 API 配置, **When** 用户点击"应用到环境变量"按钮, **Then** 系统将该配置的相关信息(API 密钥、代理地址等)设置为系统环境变量
3. **Given** 用户修改了环境变量, **When** 用户点击"清除环境变量"按钮, **Then** 系统删除之前设置的 Claude Code 相关环境变量

---

### User Story 6 - 推广导航页面展示中转服务 (Priority: P2)

用户希望在应用中能够浏览和发现市面上优质的 Claude Code 中转服务站点。应用提供一个导航页面,展示推荐的中转服务列表,用户可以直接点击跳转到服务的推广链接。这些服务信息可以从远程 JSON 文件或本地 JSON 文件加载。

**Why this priority**: 这个功能帮助用户发现优质的中转服务,同时也是应用的推广渠道。虽然不是核心代理功能,但对用户获取中转服务信息非常有价值。

**Independent Test**: 用户可以打开导航页面,看到从配置的 JSON 源(远程或本地)加载的中转服务列表,包括站点名称、是否推荐标识、热度等信息。用户点击某个服务,验证浏览器或应用打开了该服务的推广链接。

**Acceptance Scenarios**:

1. **Given** 应用配置了远程 JSON 文件 URL, **When** 用户打开导航页面, **Then** 系统从远程 URL 加载中转服务列表并显示在页面上
2. **Given** 远程 JSON 文件加载失败或网络不可用, **When** 系统尝试加载远程文件, **Then** 自动回退到本地 JSON 文件(如果配置了本地文件),并显示提示信息
3. **Given** 用户打开导航页面, **When** 页面显示中转服务列表, **Then** 每个服务显示站点名称、是否推荐标识(如推荐徽章)、热度指标(如星级或数值)
4. **Given** 用户浏览中转服务列表, **When** 用户点击某个服务项, **Then** 系统在默认浏览器中打开该服务的推广链接
5. **Given** 管理员更新了远程 JSON 文件, **When** 用户下次打开导航页面或点击刷新按钮, **Then** 系统重新加载最新的中转服务列表
6. **Given** 用户配置了本地 JSON 文件路径, **When** 用户打开导航页面, **Then** 系统优先从本地文件加载服务列表(如果配置为优先本地)

---

### User Story 7 - 多语言界面支持 (Priority: P3)

用户可以根据自己的语言偏好,在应用设置中切换界面语言(支持中文、英文等主要语言)。

**Why this priority**: 这是用户体验增强功能,但不影响核心功能使用。可以在基础功能完成后添加。

**Independent Test**: 用户可以在设置中选择"English"语言,验证所有界面文本切换为英文;然后切换回"中文",验证界面恢复中文显示。

**Acceptance Scenarios**:

1. **Given** 用户打开语言设置, **When** 用户选择不同的语言选项, **Then** 应用界面的所有文本立即切换到所选语言
2. **Given** 用户设置了语言偏好, **When** 用户关闭并重新打开应用, **Then** 应用保持上次选择的语言设置

---

### Edge Cases

- 当 Claude Code 配置文件不存在或路径无效时,如何处理?
- 当用户没有权限修改 Claude Code 配置文件时,如何提示和处理?
- 当某个分组内所有 API 配置都不可用时,自动切换功能如何处理?
- 当用户删除正在使用的配置分组时,如何处理?
- 当用户删除正在使用的 API 配置时,如何处理?
- 当用户试图删除最后一个分组或分组内最后一个配置时,如何处理?
- 当系统环境变量设置失败(权限问题)时,如何提示用户?
- 当代理服务端口被占用时,如何处理?
- 当备份的配置文件损坏或丢失时,如何恢复?
- 当用户在不同操作系统(Windows/Mac/Linux)上使用时,配置文件路径和环境变量设置是否正确处理?
- 当 API 测试请求超时时,如何设置合理的超时时间?
- 当用户同时运行多个应用实例时,配置冲突如何处理?
- 当用户创建重名的分组或配置时,如何处理?
- 当分组内只有一个可用配置时,自动切换功能是否仍然启用?
- 当用户将配置从一个分组移动到另一个分组时,当前使用的配置如何处理?
- 当用户删除"未分组"中的最后一个配置时,系统应该如何响应?
- 当远程 JSON 文件格式不正确时,如何处理?
- 当推荐服务的配置信息与用户现有配置冲突(如重名)时,如何处理?
- 当远程 JSON 文件加载时间过长时,如何设置超时时间?
- 当本地 JSON 文件不存在或损坏时,导航页面如何显示?

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须能够自动检测 Claude Code 的配置文件位置(支持 Windows、macOS 和 Linux 系统的默认路径)
- **FR-002**: 系统必须能够在修改 Claude Code 配置前自动备份原始配置文件,并提供恢复功能
- **FR-003**: 系统必须能够修改 Claude Code 配置文件,将 API 路由和模型配置指向本地 127.0.0.1 的指定端口
- **FR-004**: 系统必须能够恢复 Claude Code 的原始配置,撤销本地代理设置
- **FR-005**: 用户必须能够创建、编辑、删除配置分组,每个分组包含分组名称和描述
- **FR-006**: 用户必须能够在分组下添加、编辑、删除多个 API 中转站配置,每个配置包含:配置名称、API 密钥、服务器地址、端口号、所属分组
- **FR-007**: 系统必须能够持久化保存所有分组和 API 配置,应用重启后数据不丢失
- **FR-008**: 用户必须能够选择并切换当前使用的配置分组
- **FR-009**: 用户必须能够在当前分组内选择并切换当前使用的 API 配置
- **FR-010**: 系统必须能够启动本地代理服务,默认监听端口 25341,并将请求转发到当前选择的 API 中转站
- **FR-011**: 系统必须能够测试单个 API 配置的连接性,返回连接状态(成功/失败)和响应延迟
- **FR-012**: 系统必须能够测试单个 API 配置的有效性,验证 API 密钥是否有效
- **FR-013**: 系统必须能够批量测试某个分组内所有 API 配置,并显示每个配置的测试结果
- **FR-014**: 用户必须能够为每个分组独立启用/禁用"自动择优路由切换"功能
- **FR-015**: 当某个分组启用自动切换时,系统必须能够监测当前分组内 API 配置的可用性,当出现连接失败、超时、费用不足等错误时,按照配置顺序自动切换到同一分组内下一个可用配置
- **FR-016**: 当某个分组启用自动切换时,如果当前配置的延迟超过阈值(默认 3 秒),系统必须按照配置顺序自动切换到同一分组内下一个可用配置
- **FR-017**: 系统必须确保自动切换仅在当前分组内进行,不会跨分组切换配置
- **FR-018**: 系统必须能够记录所有自动切换事件的日志,包括切换时间、原因、源配置、目标配置、所属分组
- **FR-019**: 用户必须能够查看和管理系统环境变量(读取、设置、删除)
- **FR-020**: 系统必须能够将选定的 API 配置应用到系统环境变量中
- **FR-021**: 用户必须能够在应用设置中选择界面语言(至少支持中文和英文)
- **FR-022**: 系统必须能够保存用户的语言偏好,应用重启后保持
- **FR-023**: 系统必须在修改配置文件或环境变量失败时,显示清晰的错误提示和失败原因
- **FR-024**: 系统必须在执行关键操作(删除配置、删除分组、修改配置文件)前,提示用户确认
- **FR-025**: 系统必须能够检测本地代理端口是否被占用,并在占用时提示用户更换端口
- **FR-026**: 系统必须支持跨平台运行(Windows、macOS、Linux),并正确处理不同系统的路径和权限差异
- **FR-027**: 系统必须能够从配置的远程 URL 加载推荐的中转服务列表(JSON 格式)
- **FR-028**: 系统必须能够从本地文件路径加载推荐的中转服务列表(JSON 格式)
- **FR-029**: 系统必须优先从远程 URL 加载推荐服务列表,当远程加载失败时,自动回退到本地 JSON 文件
- **FR-030**: 用户必须能够在导航页面浏览推荐的中转服务,显示站点名称、是否推荐标识、热度指标
- **FR-031**: 用户必须能够点击导航页面中的服务项,在默认浏览器中打开该服务的推广链接
- **FR-032**: 用户必须能够手动刷新导航页面,重新加载最新的推荐服务列表
- **FR-033**: 系统必须能够缓存远程加载的推荐服务列表,减少网络请求
- **FR-034**: 系统必须支持"未分组"状态,允许用户在不创建分组的情况下添加 API 配置
- **FR-035**: 当用户切换分组时,系统必须自动切换代理服务到新分组的第一个可用配置,无需重启代理服务
- **FR-036**: 当用户试图切换到空分组(没有任何配置)时,系统必须阻止切换并提示"该分组没有任何配置,请先添加配置"
- **FR-037**: 用户必须能够通过拖拽操作调整分组内 API 配置的顺序,以设置自动切换时的优先级
- **FR-038**: 当分组内启用自动切换时,系统必须按照配置的顺序(用户可拖拽调整)依次切换到下一个可用配置

### Key Entities

- **配置分组**: 代表一组相关 API 配置的逻辑分组,包含分组名称、分组描述、是否启用自动切换、创建时间、最后修改时间。特殊分组"未分组"用于存放未分配到任何分组的配置
- **API 配置**: 代表一个 API 中转站的完整配置信息,包含配置名称、API 密钥、服务器地址、端口号、所属分组(可为"未分组")、排序顺序(用于自动切换优先级)、创建时间、最后测试时间、最后测试延迟、可用状态
- **配置备份**: 代表 Claude Code 原始配置文件的备份,包含备份文件路径、备份时间、备份内容
- **代理服务**: 代表本地运行的代理服务实例,包含监听端口、当前使用的配置分组、当前使用的 API 配置、运行状态
- **测试结果**: 代表 API 配置的测试结果,包含测试时间、连接状态、响应延迟、错误信息、所属配置、所属分组
- **切换日志**: 代表自动切换事件的记录,包含切换时间、切换原因、源配置、目标配置、所属分组、是否跨分组切换(应始终为否)
- **环境变量**: 代表系统环境变量键值对,包含变量名、变量值、设置时间
- **应用设置**: 代表应用的全局设置,包含当前语言、默认延迟阈值(默认 3 秒)、默认代理端口(默认 25341)、推荐服务源配置(远程 URL 和本地文件路径)等
- **推荐服务**: 代表导航页面展示的推荐中转服务站点,包含站点名称、推广链接 URL、是否推荐标识(布尔值或推荐级别)、热度指标(数值或星级)
- **推荐服务源**: 代表推荐服务列表的数据源配置,包含远程 JSON URL、本地 JSON 文件路径、优先级设置、缓存时间、最后更新时间

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在 30 秒内完成从安装应用到启用本地代理的全部操作
- **SC-002**: 用户能够在 10 秒内完成 API 配置的添加或切换操作
- **SC-003**: API 连接测试在 5 秒内返回结果(连接状态和延迟)
- **SC-004**: 自动路由切换在检测到 API 故障后 3 秒内完成切换
- **SC-005**: 应用支持至少 10 个不同的 API 配置同时管理
- **SC-006**: 配置文件备份和恢复操作 100% 成功,无数据丢失
- **SC-007**: 应用在 Windows、macOS 和 Linux 三个平台上均能正常运行所有核心功能
- **SC-008**: 90% 的用户能够在首次使用时无需查看文档即可完成基础配置
- **SC-009**: 应用界面响应时间不超过 200 毫秒(用户点击到界面更新)
- **SC-010**: 自动切换功能的误判率低于 5%(不应在 API 正常时错误切换)
- **SC-011**: 用户能够通过日志清晰了解所有自动切换事件的原因和结果
- **SC-012**: 应用在处理权限错误、文件不存在等异常情况时,100% 显示友好的错误提示而非崩溃

### Assumptions

- 假设 Claude Code 的配置文件格式是标准的 JSON 或 YAML 格式,可以通过编程方式读取和修改
- 假设用户已经安装了 Claude Code,并且配置文件位于系统的标准路径
- 假设 API 中转站提供标准的 HTTP/HTTPS 接口,兼容 Claude API 格式
- 假设用户拥有修改 Claude Code 配置文件的系统权限
- 假设"费用不足"错误可以通过 API 返回的错误代码或消息识别(如 HTTP 402 或特定错误信息)
- 假设延迟测试使用简单的 ping 或 HTTP 请求,测试时间不超过 5 秒
- 假设本地代理服务使用 HTTP/HTTPS 协议转发请求,与 Claude API 格式兼容
- 假设用户界面使用现代 UI 框架,支持黑金配色主题
- 假设应用数据(配置、日志等)存储在本地文件系统,使用 JSON 或 SQLite 格式
- 假设环境变量设置使用操作系统提供的标准 API,支持临时和永久设置
- 假设本地代理服务默认使用端口 25341,该端口在大多数系统上不会被占用
- 假设推荐服务 JSON 文件来源可信,不需要额外的安全验证机制
- 假设自动择优切换的默认延迟阈值为 3 秒,用户可以根据需要调整
- 假设用户可以在不创建任何分组的情况下使用应用,配置可以属于"未分组"状态
- 假设切换分组时无需重启代理服务,可以无缝切换到新分组的配置
- 假设配置的排序顺序可以通过拖拽操作调整,用于控制自动切换的优先级
- 假设空分组(没有配置)不能被选择为当前使用的分组

### Dependencies

- 依赖 Claude Code 已安装在用户系统上
- 依赖用户系统具有网络访问权限,能够连接到 API 中转站
- 依赖用户具有修改配置文件和设置环境变量的系统权限
- 依赖 API 中转站提供稳定的服务和标准的错误响应格式
